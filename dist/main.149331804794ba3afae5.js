(()=>{"use strict";var e,t={134:(e,t,i)=>{var s=i(748),n=i(437);class a{group;keys=new Map;originalKeyColors=new Map;activeKeyColor=new n.Q1f(3447003);constructor(){this.group=new n.YJl,this.createKeys()}getKey(e){return this.keys.get(e)}isBlackKey(e){return[1,3,6,8,10].includes(e%12)}pressKey(e){const t=this.getKey(e);t&&t.material instanceof n._4j&&(this.originalKeyColors.has(e)||this.originalKeyColors.set(e,t.material.color.clone()),t.material.color.set(this.activeKeyColor))}releaseKey(e){const t=this.getKey(e),i=this.originalKeyColors.get(e);t&&t.material instanceof n._4j&&i&&t.material.color.set(i)}createKeys(){const e=new n._4j({color:16777215,roughness:.5,metalness:.1}),t=new n._4j({color:2236962,roughness:.5,metalness:.1}),i=new n.iNn(1,.4,5),s=new n.iNn(.6,.6,3);let a=0,o=[];for(let e=0;e<88;e++)if(![1,3,6,8,10].includes((e+21)%12)){const e=1.05*a;o.push(e),a++}const r=-(1.05*a-.05)/2;a=0;for(let l=0;l<88;l++){const h=l+21;let c;if([1,3,6,8,10].includes(h%12)){c=new n.eaF(s,t.clone());const e=o[a-1];c.position.set(e+.5+r,(.6-.4)/2+.1,-1)}else{c=new n.eaF(i,e.clone());const t=o[a];c.position.set(t+r,0,0),a++}c.name=`key_${h}`,this.group.add(c),this.keys.set(h,c)}}}const o=[16711680,65280,255,16776960,16711935,65535,16777215,16746496,65416,8913151,8978176,35071,16711816,8947848,13369344,52224];class r{scene;piano;noteObjects;noteMap=new Map;notesByTime=[];tempColor=new n.Q1f;constructor(e,t){this.scene=e,this.piano=t,this.noteObjects=new n.YJl,this.scene.add(this.noteObjects)}visualize(e){this.clear();const t=new Map;e.tracks.forEach(e=>{9!==e.channel&&e.notes.forEach(i=>{t.has(e.channel)||t.set(e.channel,[]),t.get(e.channel)?.push(i)})}),t.forEach((e,t)=>{const i=new n.Q1f(o[t%o.length]),s=new n._4j({color:i,roughness:.5,transparent:!0,opacity:.9}),a=new n.iNn(1,.2,1),r=new n.ZLX(a,s,e.length);r.name=`channel_${t}`,e.forEach((e,s)=>{const{midi:a,time:o,duration:l}=e,h=this.piano.getKey(a);if(!h)return;const c=h.position.clone(),d=this.piano.isBlackKey(a)?.6:1,m=new n.kn4,u=.001*t,p=new n.Pq0(c.x,c.y+.1+.1+u,5*-o-5*l/2),y=new n.Pq0(.9*d,1,5*l),g=new n.PTz;m.compose(p,g,y),r.setMatrixAt(s,m);const f=`${e.midi}-${e.time}`,w=i.clone();r.setColorAt(s,w);const v={mesh:r,instanceId:s,originalColor:w,note:e};this.noteMap.set(f,v)}),r.instanceColor&&(r.instanceColor.needsUpdate=!0),this.noteObjects.add(r)}),this.notesByTime=Array.from(this.noteMap.values()).sort((e,t)=>e.note.time-t.note.time)}update(e,t){if(0===this.notesByTime.length)return;const i=new Set;t.forEach(e=>{i.add(`${e.midi}-${e.time}`)}),this.notesByTime.forEach(t=>{const{mesh:s,instanceId:n,originalColor:a,note:o}=t,r=`${o.midi}-${o.time}`,l=o.time+o.duration<e,h=i.has(r);s.getColorAt(n,this.tempColor);const c=this.tempColor.clone();h?c.copy(a).addScalar(.5):l?c.copy(a).multiplyScalar(.4):c.copy(a),this.tempColor.equals(c)||(s.setColorAt(n,c),s.instanceColor&&(s.instanceColor.needsUpdate=!0))})}resetVisuals(){this.notesByTime.forEach(e=>{const{mesh:t,instanceId:i,originalColor:s}=e;t.setColorAt(i,s),t.instanceColor&&(t.instanceColor.needsUpdate=!0)})}clear(){this.noteObjects.children.forEach(e=>{e instanceof n.ZLX&&e.dispose()}),this.noteObjects.clear(),this.noteMap.clear(),this.notesByTime=[]}}class l{audioContext;samples=new Map;instrument;baseUrl="https://raw.githubusercontent.com/nbrosowsky/tonejs-instruments/master/samples/";constructor(e,t){this.audioContext=e,this.instrument=t}async load(){const e=["C4","G4","C5"].map(async e=>{const t=`${this.baseUrl}${this.instrument}/${e}.mp3`;try{const i=await fetch(t);if(!i.ok)throw new Error(`Failed to fetch sample: ${t}`);const s=await i.arrayBuffer(),n=await this.audioContext.decodeAudioData(s);this.samples.set(e,n)}catch(t){console.error(`Could not load sample ${e} for ${this.instrument}`,t)}});await Promise.all(e)}playNote(e,t){if(0===this.samples.size)return void console.warn(`No samples loaded for ${this.instrument}, cannot play note.`);const i=this.midiToNoteName(e);i.substring(0,i.length-1);let s="",n=1/0;Array.from(this.samples.keys()).forEach(t=>{const i=this.noteNameToMidi(t),a=Math.abs(e-i);a<n&&(n=a,s=t)});const a=this.samples.get(s);if(!a)return;const o=this.audioContext.createBufferSource();o.buffer=a;const r=this.noteNameToMidi(s),l=100*(e-r);o.detune.value=l;const h=this.audioContext.createGain();h.gain.setValueAtTime(t,this.audioContext.currentTime),h.connect(this.audioContext.destination),o.connect(h),o.start()}midiToNoteName(e){const t=Math.floor(e/12)-1;return`${["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]}${t}`}noteNameToMidi(e){const t=parseInt(e.slice(-1));return{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[e.slice(0,-1)]+12*(t+1)}}const h=["sine","square","sawtooth","triangle"];class c{audioContext;activeOscillators=new Map;mainGain;samplers=new Map;activeInstrument="triangle";constructor(){this.audioContext=new window.AudioContext,this.mainGain=this.audioContext.createGain(),this.mainGain.gain.value=.3,this.mainGain.connect(this.audioContext.destination),this.loadSampler("piano")}async loadSampler(e){if(this.samplers.has(e))return;console.log(`Loading ${e}...`);const t=new l(this.audioContext,e);this.samplers.set(e,t),await t.load(),console.log(`${e} loaded.`)}setInstrument(e){this.activeInstrument=e,h.includes(e)||this.loadSampler(e)}playNote(e){if("suspended"===this.audioContext.state&&this.audioContext.resume(),h.includes(this.activeInstrument))this.playOscillatorNote(e);else{const t=this.samplers.get(this.activeInstrument);t?t.playNote(e.midi,e.velocity):(console.warn(`Sampler for ${this.activeInstrument} not found. Playing fallback sound.`),this.playOscillatorNote(e))}}playOscillatorNote(e){if(this.activeOscillators.has(e.midi))return;const t=this.audioContext.createOscillator(),i=this.audioContext.createGain(),s=440*Math.pow(2,(e.midi-69)/12);t.frequency.setValueAtTime(s,this.audioContext.currentTime),t.type=this.activeInstrument,i.gain.setValueAtTime(0,this.audioContext.currentTime),i.gain.linearRampToValueAtTime(e.velocity,this.audioContext.currentTime+.05),t.connect(i),i.connect(this.mainGain),t.start(),this.activeOscillators.set(e.midi,{oscillator:t,gainNode:i})}stopNote(e){const t=this.activeOscillators.get(e);if(t){const i=.3;t.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),t.gainNode.gain.setValueAtTime(t.gainNode.gain.value,this.audioContext.currentTime),t.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+i),t.oscillator.stop(this.audioContext.currentTime+i),this.activeOscillators.delete(e)}}stopAllNotes(){this.activeOscillators.forEach((e,t)=>{this.stopNote(t)})}resumeContext(){"suspended"===this.audioContext.state&&this.audioContext.resume()}}new class{scene;camera;renderer;piano;noteVisualizer;synth;clock;isPlaying=!1;midiData=null;playbackStartTime=0;elapsedTime=0;notesToPlay=[];nextNoteIndex=0;activeNotes=new Map;playPauseBtn;progressBar;progressElement;timeDisplay;uiContainer;instrumentSelect;initialPinchDistance=0;constructor(){this.scene=new n.Z58,this.camera=new n.ubm(60,window.innerWidth/window.innerHeight,.1,2e3),this.renderer=new n.JeP({antialias:!0}),this.piano=new a,this.noteVisualizer=new r(this.scene,this.piano),this.synth=new c,this.clock=new n.zD7,this.init(),this.animate()}init(){this.scene.background=new n.Q1f(2899536),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),document.getElementById("webgl-container")?.appendChild(this.renderer.domElement),this.camera.position.set(0,8,12),this.camera.lookAt(0,0,0);const e=new n.$p8(16777215,.7);this.scene.add(e);const t=new n.ZyN(16777215,.9);t.position.set(0,15,10),this.scene.add(t),this.piano.group.position.z=2.5,this.scene.add(this.piano.group),this.uiContainer=document.getElementById("ui-container"),this.playPauseBtn=document.getElementById("play-pause-btn"),this.progressBar=document.getElementById("progress-bar"),this.progressElement=document.getElementById("progress"),this.timeDisplay=document.getElementById("time-display"),this.instrumentSelect=document.getElementById("instrument-select"),this.playPauseBtn.addEventListener("click",()=>this.togglePlayback()),this.progressBar.addEventListener("click",e=>this.handleSeek(e)),this.instrumentSelect.addEventListener("change",e=>{const t=e.target;this.synth.setInstrument(t.value)}),window.addEventListener("resize",this.onWindowResize.bind(this),!1),document.getElementById("midi-file").addEventListener("change",e=>this.handleMidiFile(e)),this.initDragAndDrop(),this.initControls()}initControls(){const e=document.getElementById("webgl-container"),t=e=>Math.max(5,Math.min(e,50));e.addEventListener("wheel",e=>{e.preventDefault(),this.camera.position.z=t(this.camera.position.z+.01*e.deltaY)},{passive:!1}),window.addEventListener("keydown",e=>{let i=0;"-"===e.key||"_"===e.key?i=.5:"^"!==e.key&&"+"!==e.key&&"="!==e.key||(i=-.5),0!==i&&(this.camera.position.z=t(this.camera.position.z+i))}),e.addEventListener("touchstart",e=>{2===e.touches.length&&(e.preventDefault(),this.initialPinchDistance=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY))},{passive:!1}),e.addEventListener("touchmove",e=>{if(2===e.touches.length){e.preventDefault();const i=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY),s=i-this.initialPinchDistance,n=.05;this.camera.position.z=t(this.camera.position.z-s*n),this.initialPinchDistance=i}},{passive:!1}),e.addEventListener("touchend",e=>{e.touches.length<2&&(this.initialPinchDistance=0)})}initDragAndDrop(){const e=document.body;e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{if(t.preventDefault(),e.classList.remove("drag-over"),t.dataTransfer?.files){const e=t.dataTransfer.files[0];if(e){this.synth.resumeContext();const t=new FileReader;t.onload=e=>{const t=e.target?.result;t&&this.loadMidi(t)},t.readAsArrayBuffer(e)}}})}handleMidiFile(e){this.synth.resumeContext();const t=e.target;if(!t.files||0===t.files.length)return;const i=t.files[0],s=new FileReader;s.onload=e=>{const t=e.target?.result;t&&this.loadMidi(t)},s.readAsArrayBuffer(i)}async loadMidi(e){try{this.midiData=new s.Midi(e),this.noteVisualizer.visualize(this.midiData),this.notesToPlay=this.midiData.tracks.flatMap(e=>9===e.channel?[]:e.notes.map(e=>({note:e}))).sort((e,t)=>e.note.time-t.note.time),this.resetPlayback(),this.uiContainer.style.display="flex",this.updateUI()}catch(e){console.error("Error parsing MIDI file:",e),alert("Could not parse the MIDI file. Please try another one.")}}resetPlayback(){this.isPlaying=!1,this.elapsedTime=0,this.playbackStartTime=0,this.nextNoteIndex=0,this.noteVisualizer.noteObjects.position.z=0,this.playPauseBtn.textContent="Play",this.synth.stopAllNotes(),this.activeNotes.forEach(e=>this.piano.releaseKey(e.midi)),this.activeNotes.clear(),this.noteVisualizer.resetVisuals()}togglePlayback(){this.midiData&&(this.synth.resumeContext(),this.isPlaying=!this.isPlaying,this.isPlaying?(this.playbackStartTime=this.clock.getElapsedTime()-this.elapsedTime,this.playPauseBtn.textContent="Pause"):(this.synth.stopAllNotes(),this.playPauseBtn.textContent="Play"))}handleSeek(e){if(!this.midiData)return;const t=this.progressBar.getBoundingClientRect(),i=(e.clientX-t.left)/t.width;this.elapsedTime=this.midiData.duration*i,this.isPlaying&&(this.playbackStartTime=this.clock.getElapsedTime()-this.elapsedTime),this.synth.stopAllNotes(),this.activeNotes.forEach(e=>this.piano.releaseKey(e.midi)),this.activeNotes.clear(),this.noteVisualizer.resetVisuals(),this.nextNoteIndex=this.notesToPlay.findIndex(e=>e.note.time>=this.elapsedTime),-1===this.nextNoteIndex&&(this.nextNoteIndex=this.notesToPlay.length);for(let e=0;e<this.notesToPlay.length;e++){const{note:t}=this.notesToPlay[e];t.time<=this.elapsedTime&&t.time+t.duration>this.elapsedTime&&(this.piano.pressKey(t.midi),this.activeNotes.set(t.midi,t))}this.noteVisualizer.update(this.elapsedTime,this.activeNotes)}formatTime(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}updateUI(){if(!this.midiData)return;const e=this.elapsedTime/this.midiData.duration;this.progressElement.style.width=100*e+"%";const t=this.formatTime(this.elapsedTime),i=this.formatTime(this.midiData.duration);this.timeDisplay.textContent=`${t} / ${i}`}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updatePlayback(){if(this.isPlaying&&this.midiData){if(this.elapsedTime=this.clock.getElapsedTime()-this.playbackStartTime,this.elapsedTime>=this.midiData.duration)return this.elapsedTime=this.midiData.duration,void this.resetPlayback();for(;this.nextNoteIndex<this.notesToPlay.length&&this.notesToPlay[this.nextNoteIndex].note.time<=this.elapsedTime;){const{note:e}=this.notesToPlay[this.nextNoteIndex];this.synth.playNote(e),this.piano.pressKey(e.midi),this.activeNotes.set(e.midi,e),this.nextNoteIndex++}this.activeNotes.forEach((e,t)=>{e.time+e.duration<=this.elapsedTime&&(this.synth.stopNote(t),this.piano.releaseKey(t),this.activeNotes.delete(t))}),this.noteVisualizer.noteObjects.position.z=5*this.elapsedTime,this.updateUI()}}animate(){requestAnimationFrame(this.animate.bind(this)),this.updatePlayback(),this.noteVisualizer.update(this.elapsedTime,this.activeNotes),this.renderer.render(this.scene,this.camera)}}}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var a=i[e]={exports:{}};return t[e].call(a.exports,a,a.exports,s),a.exports}s.m=t,e=[],s.O=(t,i,n,a)=>{if(!i){var o=1/0;for(c=0;c<e.length;c++){for(var[i,n,a]=e[c],r=!0,l=0;l<i.length;l++)(!1&a||o>=a)&&Object.keys(s.O).every(e=>s.O[e](i[l]))?i.splice(l--,1):(r=!1,a<o&&(o=a));if(r){e.splice(c--,1);var h=n();void 0!==h&&(t=h)}}return t}a=a||0;for(var c=e.length;c>0&&e[c-1][2]>a;c--)e[c]=e[c-1];e[c]=[i,n,a]},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={792:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,a,[o,r,l]=i,h=0;if(o.some(t=>0!==e[t])){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(l)var c=l(s)}for(t&&t(i);h<o.length;h++)a=o[h],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(c)},i=self.webpackChunkmidi_visualizer=self.webpackChunkmidi_visualizer||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n=s.O(void 0,[96],()=>s(134));n=s.O(n)})();